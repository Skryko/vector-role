---
- name: Install dependencies (Debian)
  ansible.builtin.apt:
    name: "{{ vector_deps_debian }}"
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

- name: Create installation directory
  ansible.builtin.file:
    path: "{{ vector_install_dir }}"
    state: directory
    mode: "0755"

- name: Download Vector archive
  ansible.builtin.get_url:
    url: "{{ vector_download_url }}"
    dest: "/tmp/vector.tar.gz"
    mode: "0644"
    timeout: 30

- name: Extract Vector archive
  ansible.builtin.unarchive:
    src: "/tmp/vector.tar.gz"
    dest: "{{ vector_install_dir }}"
    remote_src: true
    extra_opts: ["--strip-components=1"]
    creates: "{{ vector_install_dir }}/bin/vector"

- name: Install Vector binary
  ansible.builtin.copy:
    src: "{{ vector_install_dir }}/vector-x86_64-unknown-linux-gnu/bin/vector"
    dest: "{{ vector_binary_path }}"
    mode: "0755"
    remote_src: true
    owner: root
    group: root
  notify: restart vector

- name: Create vector group
  ansible.builtin.group:
    name: "{{ vector_group }}"
    system: true
    state: present

- name: Create vector user
  ansible.builtin.user:
    name: "{{ vector_user }}"
    group: "{{ vector_group }}"
    system: true
    shell: /bin/false
    home: "{{ vector_data_dir }}"

- name: Create directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ vector_user }}"
    group: "{{ vector_group }}"
    mode: "0755"
  loop:
    - "{{ vector_config_dir }}"
    - "{{ vector_data_dir }}"
    - "/var/log/vector"

- name: Deploy Vector config
  ansible.builtin.template:
    src: "vector.toml.j2"
    dest: "{{ vector_config_path }}"
    mode: "0640"
    owner: "{{ vector_user }}"
    group: "{{ vector_group }}"
  notify: restart vector

- name: Deploy systemd unit
  ansible.builtin.template:
    src: "vector.service.j2"
    dest: "/etc/systemd/system/vector.service"
    mode: "0644"
  notify: restart vector

- name: Ensure Vector is started
  ansible.builtin.systemd:
    name: vector
    state: started
    enabled: true
    daemon_reload: true
